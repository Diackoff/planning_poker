<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Agile Poker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-900 text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const urlParams = new URLSearchParams(window.location.search);
        let roomId = urlParams.get('room');
        if (!roomId) {
            roomId = Math.random().toString(36).substring(2, 9);
            window.history.replaceState({}, '', `?room=${roomId}`);
        }

        const socket = io('https://planning-poker-tool.onrender.com'); 

        function App() {
            const [roomState, setRoomState] = useState({ players: [], features: [], revealed: false, estimationFinished: false, activeStoryId: null, totals: {BE:0, FE:0, QA:0} });
            const [userName, setUserName] = useState('');
            const [role, setRole] = useState('BE');
            const [isScrumMaster, setIsScrumMaster] = useState(false);
            const [joined, setJoined] = useState(false);
            const [tempScores, setTempScores] = useState({ BE: 0, FE: 0, QA: 0 });

            useEffect(() => {
                socket.on('ROOM_STATE', (state) => {
                    if (!state) return;
                    setRoomState(state);
                    const allStories = (state.features || []).flatMap(f => f.stories || []);
                    const active = allStories.find(s => s.id === state.activeStoryId);
                    if (active) setTempScores(active.finalScores || { BE: 0, FE: 0, QA: 0 });
                });
            }, []);

            const joinRoom = () => {
                if (!userName) return alert("Please enter your name");
                socket.emit('JOIN_ROOM', { roomId, userName, role: isScrumMaster ? 'SM' : role, isScrumMaster });
                setJoined(true);
            };

            const isMeSM = (roomState.players || []).find(p => p.id === socket.id)?.isScrumMaster;
            const activeStory = (roomState.features || []).flatMap(f => f.stories || []).find(s => s.id === roomState.activeStoryId);
            const voters = (roomState.players || []).filter(p => !p.isScrumMaster);

            const formatUrl = (url) => {
                if (!url) return '';
                const trimmed = url.trim();
                return trimmed.startsWith('http') ? trimmed : `https://${trimmed}`;
            };

            if (!joined) {
                return (
                    <div className="flex items-center justify-center h-screen bg-slate-900 text-white">
                        <div className="bg-slate-800 p-8 rounded-2xl shadow-2xl w-96 border border-slate-700 text-center">
                            <h2 className="text-2xl font-black mb-2 text-blue-400 font-mono italic uppercase tracking-tighter">Agile Poker</h2>
                            <p className="text-[10px] text-slate-500 mb-6 uppercase tracking-widest italic font-bold">Room: {roomId}</p>
                            <input type="text" placeholder="Your Name" className="w-full p-3 mb-4 bg-slate-900 rounded border border-slate-700 outline-none focus:border-blue-500" onChange={(e) => setUserName(e.target.value)} />
                            <select disabled={isScrumMaster} className="w-full p-3 mb-4 bg-slate-900 rounded border border-slate-700 outline-none" value={role} onChange={(e) => setRole(e.target.value)}>
                                <option value="BE">Backend</option>
                                <option value="FE">Frontend</option>
                                <option value="QA">QA</option>
                            </select>
                            <label className="flex items-center gap-2 mb-6 cursor-pointer text-sm text-slate-400 justify-center">
                                <input type="checkbox" checked={isScrumMaster} onChange={(e) => setIsScrumMaster(e.target.checked)} className="w-4 h-4 accent-blue-500" />
                                <span>I am Scrum Master</span>
                            </label>
                            <button onClick={joinRoom} className="w-full bg-blue-600 p-3 rounded-xl font-black uppercase tracking-widest hover:bg-blue-500 transition-all shadow-lg">Login</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex h-screen overflow-hidden font-sans bg-slate-900">
                    <div className="w-80 bg-slate-800 border-r border-slate-700 flex flex-col">
                        <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/20">
                            <span className="font-black text-[10px] text-slate-500 uppercase tracking-widest italic">Backlog</span>
                            <button onClick={() => navigator.clipboard.writeText(window.location.href) & alert("Room Link Copied!")} className="text-[9px] bg-slate-700 px-2 py-1 rounded text-blue-400 font-bold hover:bg-slate-600 uppercase">Room Link</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {(roomState.features || []).map(f => (
                                <div key={f.id} className="space-y-1">
                                    <div className="flex justify-between items-center">
                                        <span className="font-black text-[10px] text-blue-500 uppercase italic truncate pr-2">
                                            {typeof f.name === 'object' ? String(f.name.name || "Sprint") : String(f.name)}
                                        </span>
                                        {isMeSM && (
                                            <button onClick={() => {
                                                const sName = prompt("Story Name:");
                                                if(!sName) return;
                                                const sUrl = prompt("Story Link (optional):");
                                                socket.emit('ADD_STORY', { roomId, featureId: f.id, storyName: sName, storyUrl: formatUrl(sUrl) });
                                            }} className="text-white bg-blue-600 hover:bg-blue-500 text-[9px] font-bold px-2 rounded tracking